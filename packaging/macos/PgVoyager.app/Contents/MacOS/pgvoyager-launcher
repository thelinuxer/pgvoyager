#!/bin/bash
# PgVoyager macOS Launcher - starts server and opens browser

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
RESOURCES_DIR="$(dirname "$SCRIPT_DIR")/Resources"
PGVOYAGER_BIN="${RESOURCES_DIR}/pgvoyager"
PGVOYAGER_PORT="${PGVOYAGER_PORT:-8081}"
PGVOYAGER_URL="http://localhost:${PGVOYAGER_PORT}"

# Check if pgvoyager is already running
if pgrep -f "pgvoyager.*PGVOYAGER_MODE=production" > /dev/null 2>&1; then
    # Already running, just open browser
    open "${PGVOYAGER_URL}"
    exit 0
fi

# Start pgvoyager in background
PGVOYAGER_MODE=production PGVOYAGER_PORT="${PGVOYAGER_PORT}" "${PGVOYAGER_BIN}" &
PGVOYAGER_PID=$!

# Wait for server to be ready
for i in {1..30}; do
    if curl -s "${PGVOYAGER_URL}" > /dev/null 2>&1; then
        break
    fi
    sleep 0.2
done

# Open browser
open "${PGVOYAGER_URL}"

# Keep running until the server exits
wait $PGVOYAGER_PID
